<div [style.opacity]="isBusy ? 1 : 0">
  <mat-progress-bar mode="indeterminate"></mat-progress-bar>
</div>
<div
  *ngIf="
    state.state === 'enterEmail' ||
    (state.state === 'tryingEmail' && !state.isResend) ||
    state.state === 'emailError' ||
    state.state === 'tryingAnonymous' ||
    state.state === 'anonymousError'
  "
>
  <form [formGroup]="emailForm" (ngSubmit)="submitEmailRequest()">
    <p *ngIf="acceptingInvitation">
      To share someone's grocery list, you'll need to sign in first.
    </p>
    <mat-form-field [style.width.ch]="23">
      <mat-label>Email</mat-label>
      <input
        [readonly]="isBusy"
        matInput
        [formControl]="emailControl"
        type="email"
        required
      />
      <mat-error>Enter a valid email address</mat-error>
    </mat-form-field>
    <div fxLayoutGap="1rem" fxLayout="row" fxLayoutAlign="start start">
      <button
        *ngIf="!acceptingInvitation"
        mat-button
        mat-raised-button
        type="button"
        [disabled]="isBusy"
        (click)="update({ event: 'startAnonymous' })"
      >
        SIGN IN ANONYMOUSLY
      </button>
      <button
        [disabled]="isBusy"
        mat-button
        mat-raised-button
        color="primary"
        type="submit"
      >
        NEXT
      </button>
    </div>
  </form>
</div>
<div
  *ngIf="
    state.state === 'emailSuccess' ||
    (state.state === 'tryingEmail' && state.isResend) ||
    state.state === 'emailError'
  "
>
  <div *ngIf="state.state === 'tryingEmail'">
    Sending again to <strong>{{ state.email }}</strong>
  </div>
  <div *ngIf="state.state !== 'tryingEmail'">
    <p>
      An email was sent to <strong>{{ state.email }}</strong>
    </p>
    <p>
      Open the message to finish signing in. If you don't see the email, check
      your junk folder or
      <a
        [routerLink]=""
        (click)="update({ event: 'sendAgain', email: state.email })"
        >send the link again</a
      >
    </p>
    <div fxLayout="row" fxLayoutGap="1rem">
      <div>
        <button
          mat-button
          mat-raised-button
          (click)="update({ event: 'useDifferentEmail' })"
          type="button"
          [disabled]="isBusy"
        >
          BACK
        </button>
      </div>
    </div>
  </div>
</div>

<div *ngIf="state.state === 'anonymousSuccess'">
  You have been signed in anonymously.
</div>
<ng-template #errordialog>
  <div *ngIf="state.state === 'emailError'" mat-dialog-content>
    <p>{{ state.error }}</p>
  </div>
  <div *ngIf="state.state === 'anonymousError'" mat-dialog-content>
    <p>{{ state.error }}</p>
  </div>
  <div mat-dialog-actions style="justify-content: flex-end">
    <button
      (click)="update({ event: 'dismissError' })"
      mat-button
      mat-dialog-close
    >
      DISMISS
    </button>
  </div>
</ng-template>
